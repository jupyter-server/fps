
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Fast Pluggable System">
      
      
      
      
        <link rel="prev" href="../install/">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.9">
    
    
      
        <title>Guide - FPS</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="black">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#the-simplest-application" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="FPS" class="md-header__button md-logo" aria-label="FPS" data-md-component="logo">
      
  <img src="../jupyter.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            FPS
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Guide
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="black"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="black"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/jupyter-server/fps" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="FPS" class="md-nav__button md-logo" aria-label="FPS" data-md-component="logo">
      
  <img src="../jupyter.svg" alt="logo">

    </a>
    FPS
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jupyter-server/fps" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Install
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Guide
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Guide
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-simplest-application" class="md-nav__link">
    <span class="md-ellipsis">
      The simplest application
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sharing-objects-between-modules" class="md-nav__link">
    <span class="md-ellipsis">
      Sharing objects between modules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-pluggable-web-server" class="md-nav__link">
    <span class="md-ellipsis">
      A pluggable web server
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-declarative-application" class="md-nav__link">
    <span class="md-ellipsis">
      A declarative application
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-note-on-concurrency" class="md-nav__link">
    <span class="md-ellipsis">
      A note on concurrency
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#contexts" class="md-nav__link">
    <span class="md-ellipsis">
      Contexts
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-simplest-application" class="md-nav__link">
    <span class="md-ellipsis">
      The simplest application
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sharing-objects-between-modules" class="md-nav__link">
    <span class="md-ellipsis">
      Sharing objects between modules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-pluggable-web-server" class="md-nav__link">
    <span class="md-ellipsis">
      A pluggable web server
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-declarative-application" class="md-nav__link">
    <span class="md-ellipsis">
      A declarative application
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-note-on-concurrency" class="md-nav__link">
    <span class="md-ellipsis">
      A note on concurrency
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#contexts" class="md-nav__link">
    <span class="md-ellipsis">
      Contexts
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>Guide</h1>

<h2 id="the-simplest-application">The simplest application</h2>
<p>Let's create our first FPS application. Enter the following code in a file called <code>simple.py</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fps</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Main</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;greeting&quot;</span><span class="p">])</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;farewell&quot;</span><span class="p">])</span>
</code></pre></div>
<p>And enter in the terminal:</p>
<div class="highlight"><pre><span></span><code>fps<span class="w"> </span>simple:Main<span class="w"> </span>--set<span class="w"> </span><span class="nv">greeting</span><span class="o">=</span><span class="s2">&quot;Hello, World!&quot;</span><span class="w"> </span>--set<span class="w"> </span><span class="nv">farewell</span><span class="o">=</span><span class="s2">&quot;See you later!&quot;</span>
</code></pre></div>
<p>This should print <code>Hello, World!</code> and hang forever, which means that the application is running. To exit, press Ctrl-C. This should now print <code>See you later!</code> and return to the terminal prompt.</p>
<p>What happened?</p>
<ul>
<li>By entering <code>fps simple:Main</code>, we told FPS to run the module called <code>Main</code> in the <code>simple.py</code> file.</li>
<li>Options <code>--set greeting="Hello, World!"</code> and <code>--set farewell="See you later!"</code> told FPS to pass parameter keys <code>greeting</code> and <code>farewell</code> to <code>Main.__init__</code>'s keyword arguments, with values <code>"Hello, World!"</code> and <code>"See you later!"</code>, respectively.</li>
<li>In its startup phase (<code>start</code> method), <code>Main</code> prints the <code>greeting</code> parameter value.</li>
<li>After starting, the application runs until it is stopped. Pressing Ctrl-C stops the application, calling its teardown phase.</li>
<li>In its teardown phase (<code>stop</code> method), <code>Main</code> prints the <code>farewell</code> parameter value.</li>
</ul>
<h2 id="sharing-objects-between-modules">Sharing objects between modules</h2>
<p>Now let's see how we can share objects between modules. Enter the following code in a file called <code>share.py</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">anyio</span><span class="w"> </span><span class="kn">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">sleep</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fps</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Main</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="n">Publisher</span><span class="p">,</span> <span class="s2">&quot;publisher&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="n">Consumer</span><span class="p">,</span> <span class="s2">&quot;consumer&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Publisher</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shared</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>  <span class="c1"># the object to share</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shared</span><span class="p">,</span> <span class="n">Event</span><span class="p">)</span>  <span class="c1"># publish the shared object as type Event</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Published:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="n">is_set</span><span class="p">())</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>  <span class="c1"># wait for the shared object to be updated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exit_app</span><span class="p">()</span>  <span class="c1"># force the application to exit</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Got:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="n">is_set</span><span class="p">())</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Consumer</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shared</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Event</span><span class="p">)</span>  <span class="c1"># request an object of type Event</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Acquired:&quot;</span><span class="p">,</span> <span class="n">shared</span><span class="o">.</span><span class="n">is_set</span><span class="p">())</span>
        <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>  <span class="c1"># wait before updating the shared object</span>
        <span class="n">shared</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>  <span class="c1"># update the shared object</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Updated:&quot;</span><span class="p">,</span> <span class="n">shared</span><span class="o">.</span><span class="n">is_set</span><span class="p">())</span>
</code></pre></div>
<p>And enter in the terminal:</p>
<div class="highlight"><pre><span></span><code>fps<span class="w"> </span>share:Main
</code></pre></div>
<p>You should see in the terminal:
<div class="highlight"><pre><span></span><code>Published: False
Acquired: False
Updated: True
Got: True
</code></pre></div></p>
<p>Sharing objects between modules is based on types: a module (<code>Consumer</code>) requests an object of a given type (<code>Event</code>) with <code>await self.get</code>, and it eventually acquires it when another module (<code>Publisher</code>) publishes an object of this type with <code>self.put</code>. It is the same object that they are sharing, so if <code>Consumer</code> changes the object, <code>Publisher</code> sees it immediatly.</p>
<p>The <code>Consumer</code>'s default value for parameter <code>wait</code> is 0, which means that the shared object will be updated right away. If we set it to 0.5 seconds:</p>
<div class="highlight"><pre><span></span><code>fps<span class="w"> </span>share:Main<span class="w"> </span>--set<span class="w"> </span>consumer.wait<span class="o">=</span><span class="m">0</span>.5
</code></pre></div>
<p>You should see that the application hangs for half a second after the shared object is acquired. This illustrate that we can configure any nested module in the application, just by providing the path to its parameter in the CLI. If we provide a wrong parameter name, we get a nice error:</p>
<div class="highlight"><pre><span></span><code>fps<span class="w"> </span>share:Main<span class="w"> </span>--set<span class="w"> </span>consumer.wrong_parameter<span class="o">=</span><span class="m">0</span>.5
</code></pre></div>
<div class="highlight"><pre><span></span><code>RuntimeError: Cannot instantiate module &#39;root_module.consumer&#39;: Consumer.__init__() got an unexpected keyword argument &#39;wrong_parameter&#39;
</code></pre></div>
<h2 id="a-pluggable-web-server">A pluggable web server</h2>
<p>FPS comes with a <code>FastAPIModule</code> that publishes a <code>FastAPI</code> application. This <code>FastAPI</code> object can be shared with other modules, which can add routes to it. As part of its startup phase, <code>FastAPIModule</code> serves the <code>FastAPI</code> application with a web server. Enter the following code in a file called <code>server.py</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fps</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fps.web.fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPIModule</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Main</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="n">FastAPIModule</span><span class="p">,</span> <span class="s2">&quot;fastapi&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="n">Router</span><span class="p">,</span> <span class="s2">&quot;router&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Router</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">app</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FastAPI</span><span class="p">)</span>
        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">read_root</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">}</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
</code></pre></div>
<p>And enter in the terminal:</p>
<div class="highlight"><pre><span></span><code>fps<span class="w"> </span>server:Main
</code></pre></div>
<p>Now if you open a browser at <code>http://127.0.0.1:8000</code>, you should see:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="nt">&quot;count&quot;</span><span class="p">:</span><span class="mi">3</span><span class="p">}</span>
</code></pre></div>
<p>Note that <code>Router</code> has a <code>prepare</code> method. It is similar to the <code>start</code> method, be it is executed just before. Typically, this is used by modules like <code>FastAPIModule</code> which must give a chance to every other module to register their routes on the <code>FastAPI</code> application, before running the server in <code>start</code>, because routes cannot be added once the server has started.</p>
<p>See how <code>Router</code> uses a Pydantic model <code>Config</code> to validate its configuration. With this, running the application with a wrong type will not work:</p>
<div class="highlight"><pre><span></span><code>fps<span class="w"> </span>main:Main<span class="w"> </span>--set<span class="w"> </span>router.value<span class="o">=</span>foo
<span class="c1"># RuntimeError: Cannot instantiate module &#39;root_module.router&#39;: 1 validation error for Config</span>
<span class="c1"># value</span>
<span class="c1">#   Input should be a valid integer, unable to parse string as an integer [type=int_parsing, input_value=&#39;foo&#39;, input_type=str]</span>
<span class="c1">#     For further information visit https://errors.pydantic.dev/2.10/v/int_parsing</span>
</code></pre></div>
<p><a href="https://github.com/jupyter-server/jupyverse">Jupyverse</a> uses <code>FastAPIModule</code> in order to compose a Jupyter server from swappable pluggins.</p>
<h2 id="a-declarative-application">A declarative application</h2>
<p>It is possible to configure an application entirely as a Python dictionary or a JSON file. Let's rewrite the previous example in <code>router.py</code>, and just keep the code for the <code>Router</code> module:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fps</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Router</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">app</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FastAPI</span><span class="p">)</span>
        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">read_root</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">}</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
</code></pre></div>
<p>Now we can write a <code>config.json</code> file like so:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;main&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;fps_module&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;modules&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;fastapi&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;fps.web.fastapi:FastAPIModule&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;router&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;router:Router&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;config&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>And launch our application with:</p>
<div class="highlight"><pre><span></span><code>fps<span class="w"> </span>--config<span class="w"> </span>config.json
</code></pre></div>
<p>Note that the <code>type</code> field in <code>config.json</code> can be a path to a module, like <code>fps.web.fastapi:FastAPIModule</code> or <code>router:Router</code>, or a module name registered in the <code>fps.modules</code> entry-point group, like <code>fps_module</code> which is a base FPS <code>Module</code>.</p>
<h2 id="a-note-on-concurrency">A note on concurrency</h2>
<p>The following <code>Module</code> methods are run as background tasks:</p>
<ul>
<li><code>prepare</code></li>
<li><code>start</code></li>
<li><code>stop</code></li>
</ul>
<p>FPS will consider each of them to have completed if they run to completion, or if they call <code>self.done()</code>. Let's consider the following example:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">anyio</span><span class="w"> </span><span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fps</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyModule</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">))</span>
</code></pre></div>
<p>FPS will notice that this module never completes the startup phase, because its <code>start</code> method hangs indefinitely. By default, this will time out after one second. The solution is to launch a background task and then explicitly call <code>self.done()</code>, like so:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">anyio</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_task_group</span><span class="p">,</span> <span class="n">sleep</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fps</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyModule</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
            <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">sleep</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
</code></pre></div>
<h2 id="contexts">Contexts</h2>
<p>FPS offers a <code>Context</code> class that allows to share objects independantly of modules. For instance, say you want to share a file object. Here is how you would do:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">TextIOWrapper</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">anyio</span><span class="w"> </span><span class="kn">import</span> <span class="n">run</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fps</span><span class="w"> </span><span class="kn">import</span> <span class="n">Context</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">Context</span><span class="p">()</span> <span class="k">as</span> <span class="n">context</span><span class="p">:</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;log.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File opened&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">teardown_callback</span><span class="p">():</span>
            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File closed&quot;</span><span class="p">)</span>

        <span class="n">shared_file</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">teardown_callback</span><span class="o">=</span><span class="n">teardown_callback</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File object published&quot;</span><span class="p">)</span>
        <span class="n">acquired_file</span> <span class="o">=</span> <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">TextIOWrapper</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File object acquired&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">acquired_file</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span> <span class="ow">is</span> <span class="n">file</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing to file&quot;</span><span class="p">)</span>
        <span class="n">acquired_file</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Hello, World!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">acquired_file</span><span class="o">.</span><span class="n">drop</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File object dropped&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">shared_file</span><span class="o">.</span><span class="n">freed</span><span class="p">()</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</code></pre></div>
<p>Running this code will print:</p>
<div class="highlight"><pre><span></span><code>File opened
File object published
File object acquired
Writing to file
File object dropped
File closed
</code></pre></div>
<p>Let's see what happened:
- We created an object that we want to share, here <code>file</code>. This file has to be closed eventually.
- We published it in the <code>context</code>, with <code>context.put(file, teardown_callback=teardown_callback)</code>. The <code>teardown_callback</code> will be called when the context is closed. We got a <code>shared_file</code> handle that we can use to check if the object is still in use (see below).
- We acquired the file object with <code>await context.get(TextIOWrapper)</code>, and we got an <code>acquired_file</code> handle that we can use to drop the object when we are done using it. Note that acquiring an object is usually done in some other part of the program, where only the <code>context</code> is available.
- We write to the file using <code>acquired_file.unwrap().write("Hello, World!\n")</code>. Note that we call <code>unwrap()</code> to get the actual object, since our handle is a wrapper around the object.
- We drop the file object with <code>acquired_file.drop()</code>, notifying the <code>shared_file</code> that we are done using it and that from our point of view it is safe to close it.
- The publisher can check that the published file is not used anymore with <code>await shared_file.freed()</code>.
- When the <code>context</code> is closed, it waits for every published object to be freed and then it proceeds with their teardown, if any.</p>
<p>Contexts ensure that objects are shared safely by their "owner" and that they are torn down when they are not being used anymore, by keeping references of "borrowers". Borrowers must collaborate by explicitly dropping objects when they are done using them. Owners can explicitly check that their objects are free to be disposed, althoug this is optional.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.instant", "navigation.top", "navigation.sections", "search.suggest", "search.highlight", "content.code.annotate", "content.code.copy"], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>